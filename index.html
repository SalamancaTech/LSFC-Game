<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latent Space Fight Club: Isometric Engine</title>
    <!-- Font Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --ui-bg: rgba(22, 33, 62, 0.95);
            --ui-border: #0f3460;
            --accent: #e94560;
            --player-color: #3498db;
            --enemy-color: #e67e22;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; background: #000; overflow: hidden; transition: all 0.3s ease; }
        .handheld-mode { width: 100%; height: 100%; max-width: 450px !important; max-height: 800px !important; border: 4px solid #333; border-radius: 20px; box-shadow: 0 0 100px rgba(0,0,0,0.8); }
        canvas { display: block; width: 100%; height: 100%; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            background: var(--ui-bg); z-index: 10; padding: 20px; box-sizing: border-box;
            text-align: center; background-size: cover; background-position: center;
        }
        
        .overlay-dimmer { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); z-index: -1; }
        .watermark { position: absolute; bottom: 10px; left: 15px; font-family: 'Hachi Maru Pop', cursive; opacity: 0.33; color: rgba(255, 255, 255, 0.8); font-size: 1.2rem; z-index: 100; pointer-events: none; }

        #oc-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: none;
            align-items: center; gap: 10px; z-index: 5; background: rgba(0,0,0,0.5);
            padding: 5px 15px; border-radius: 30px; backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.1);
        }

        .hud-slots { display: flex; gap: 8px; }
        .oc-icon { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid #555; overflow: hidden; position: relative; }
        .oc-icon img { width: 100%; height: 100%; object-fit: cover; }
        .lead-star { position: absolute; top: 0; right: 0; color: #f1c40f; font-size: 0.8rem; text-shadow: 0 1px 2px black; }
        .hud-expand-btn { background: #34495e; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #team-drawer {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--ui-bg); border: 1px solid var(--ui-border);
            border-radius: 8px; padding: 15px; display: none; z-index: 20; flex-direction: column; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; }
        .team-member { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; position: relative; }
        .team-member.active { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .team-member.lead { border-color: #f1c40f; }
        .team-member img { width: 40px; height: 40px; object-fit: contain; }
        .team-member-name { font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

        #switch-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 350px; background: var(--ui-bg); border: 2px solid var(--ui-border);
            border-radius: 12px; padding: 20px; z-index: 30; display: none; flex-direction: column; gap: 10px;
        }

        /* --- TITLE SCREEN UI --- */
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; width: 100%; max-width: 600px; margin-top: 20px; }
        .selection-card { background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; }
        .selection-card:hover { border-color: var(--accent); background: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .selection-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 8px; }
        .selection-name { font-size: 0.8rem; font-weight: bold; }

        /* --- BATTLE SCREEN ELEMENTS --- */
        #battle-scene { flex-grow: 2; display: flex; justify-content: space-around; align-items: center; width: 100%; max-width: 800px; position: relative; }
        .battler { width: 220px; height: 220px; transition: transform 0.2s, filter 0.5s; z-index: 2; position: relative; animation: idle-breath 3.5s ease-in-out infinite; }
        .battler::after { content: ''; position: absolute; bottom: 5px; left: 10%; width: 80%; height: 15px; background: radial-gradient(ellipse at center, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 70%); z-index: -1; border-radius: 50%; transform: translateY(10px); }
        .img-layer { width: 100%; height: 100%; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        .img-layer img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }

        #enemy-move-slot {
            position: absolute; top: -100px; right: 0px; width: 80px; height: 80px; background: rgba(0,0,0,0.8);
            border: 3px solid var(--enemy-color); border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; z-index: 5; box-shadow: 0 0 20px rgba(230, 126, 34, 0.5); opacity: 0; transition: opacity 0.2s, transform 0.2s;
        }

        /* Animations */
        @keyframes idle-breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03) translateY(-3px); } }
        @keyframes wind-up-right { 0% { transform: translateX(0) scale(1); } 100% { transform: translateX(-30px) scale(0.95) rotate(-5deg); filter: brightness(1.2); } }
        @keyframes wind-up-left { 0% { transform: translateX(0) scale(1); } 100% { transform: translateX(30px) scale(0.95) rotate(5deg); filter: brightness(1.2); } }
        .anim-windup-right { animation: wind-up-right 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        .anim-windup-left { animation: wind-up-left 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes lunge-right { 0% { transform: translateX(0); } 50% { transform: translateX(60px) scale(1.1); } 100% { transform: translateX(0); } }
        @keyframes lunge-left { 0% { transform: translateX(0); } 50% { transform: translateX(-60px) scale(1.1); } 100% { transform: translateX(0); } }
        .anim-lunge-right { animation: lunge-right 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .anim-lunge-left { animation: lunge-left 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes damage-flash { 0% { filter: brightness(1); } 25% { filter: brightness(5) sepia(1) hue-rotate(-50deg); } 100% { filter: brightness(1); } }
        .anim-damage { animation: damage-flash 0.5s ease-out; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div class="watermark">SalamancaTech</div>

    <div id="oc-hud">
        <div class="hud-slots" id="hud-slots"></div>
        <button class="hud-expand-btn" onclick="toggleTeamDrawer()">‚ñº</button>
    </div>

    <div id="team-drawer">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4 style="margin:0;">Convinced OCs</h4>
            <button onclick="toggleTeamDrawer()" style="background:none; border:none; color:#aaa; cursor:pointer;">‚úñ</button>
        </div>
        <div class="team-grid" id="team-grid"></div>
    </div>

    <div id="menu-btn" onclick="toggleMainMenu()" style="position: absolute; top: 20px; right: 20px; z-index: 50; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); font-size: 1.5rem;">‚ò∞</div>

    <div id="main-menu" class="overlay" style="z-index: 30;">
        <div style="background: #16213e; padding: 30px; border-radius: 16px; min-width: 300px; display: flex; flex-direction: column; gap: 15px;">
            <h2 style="margin:0; color:var(--accent);">PAUSED</h2>
            <button onclick="closeAllMenus()" style="padding:15px; cursor:pointer;">Resume Game</button>
            <button onclick="openSettings()" style="padding:15px; cursor:pointer;">Settings</button>
        </div>
    </div>

    <div id="settings-menu" class="overlay" style="z-index: 31;">
        <div style="background: #16213e; padding: 30px; border-radius: 16px; min-width: 350px; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin:0;">Settings</h2>
            <div id="latent-list-container" style="margin-top:20px; background:rgba(0,0,0,0.3); padding:10px;"></div>
            <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                <button onclick="toggleCheat('showCatchRate')" id="cheat-rate">Show Convince %: OFF</button>
                <button onclick="toggleBattleStyle()" id="style-toggle">Mode: Easy</button>
                <button onclick="toggleViewMode()" id="view-toggle">View: Immersive</button>
            </div>
            <button onclick="closeSettings()" style="margin-top:20px; width:100%; padding:10px;">Back</button>
        </div>
    </div>

    <div id="start-screen" class="overlay" style="display: flex; background: #000;">
        <div class="overlay-dimmer"></div>
        <h1 style="color:var(--accent); font-size: 2.5rem;">LATENT SPACE FIGHT CLUB</h1>
        <div style="text-align:center; position:relative; z-index:2; width:100%;">
             <h3 style="margin-bottom:10px;">Choose Your Partner</h3>
             <div id="starter-selection" class="selection-grid" style="justify-content: center; display: flex; flex-wrap: wrap; gap:10px;"></div>
        </div>
    </div>

    <div id="battle-ui" class="overlay">
        <div class="battle-header" style="width:100%; display:flex; justify-content:space-between; max-width:600px;">
            <div class="health-box">
                <div id="player-name">YOU</div>
                <div class="hp-bar-bg"><div id="player-hp-bar" class="hp-bar-fill"></div></div>
                <div id="player-hp-text">100/100</div>
            </div>
            <div class="health-box" style="border-color: var(--enemy-color)">
                <div id="enemy-name">WILD OC</div>
                <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill" style="background:var(--accent);"></div></div>
                <div id="enemy-hp-text">100/100</div>
            </div>
        </div>
        <div id="battle-scene">
            <div id="battle-hero" class="battler"><div id="hero-img-layer" class="img-layer"></div></div>
            <div id="battle-enemy" class="battler">
                <div id="enemy-img-layer" class="img-layer"></div>
                <div id="enemy-speech" class="speech-bubble" style="opacity:0;"></div>
                <div id="enemy-move-slot">?</div>
            </div>
        </div>
        <div id="battle-log" style="height:60px; display:flex; align-items:center; justify-content:center;">Ready...</div>
        <div class="battle-controls" id="battle-controls-area"></div>
    </div>

    <div id="result-screen" class="overlay">
        <h2 id="result-title">VICTORY!</h2>
        <button class="btn-primary" onclick="returnToOverworld()">Continue</button>
    </div>
</div>

<script>
/* --- 1. CONSTANTS & ENUMS --- */
const STATE = { START: 0, OVERWORLD: 1, BATTLE: 2, TRANSITION: 3 };
const CONFIG = { gridSize: 15, tileSize: 80, scale: 1.0, colors: { bg: '#1a1a2e' } };

const SPECIES_DB = [
    { id: "Witty_Designer", name: "Witty Designer", battle: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/battle/stable-diffusion-a-witty-elegance-v0-me5rmoonwecg1.webp", overworld: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/overworld/wittywalksprite1.png" },
    { id: "Usami", name: "Usami", battle: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/battle/dango00.png", overworld: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/overworld/usamispritetest.png" },
    { id: "Storm_Wulf", name: "Storm Wulf", battle: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/battle/stormwulfbattle00.png", overworld: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/overworld/stormwulf-sprite01.png" },
    { id: "Mr_Tick", name: "Mr Tick", battle: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/battle/tickbase00.png", overworld: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/overworld/TickSprite.png" },
    { id: "Legion", name: "Legion", battle: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/battle/legionpencil.jpg", overworld: "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/ocs/overworld/Leahsprite00.png" }
];

const MATCHUPS = {
    'Rock': { beats: ['Scissors', 'Lizard'] }, 'Paper': { beats: ['Rock', 'Spock'] }, 'Scissors': { beats: ['Paper', 'Lizard'] },
    'Lizard': { beats: ['Spock', 'Paper'] }, 'Spock': { beats: ['Scissors', 'Rock'] }
};

const MOVES_INFO = { 
    'Rock': { icon: 'ü™®', color: '#7f8c8d' }, 
    'Paper': { icon: 'üìú', color: '#ecf0f1' }, 
    'Scissors': { icon: '‚úÇÔ∏è', color: '#c0392b' }, 
    'Lizard': { icon: 'ü¶é', color: '#2ecc71' }, 
    'Spock': { icon: '‚ú®', color: '#9b59b6' } 
};

/* --- 2. UTILITIES --- */
function generateLatentSVG(colorBody, colorHair, expression = 'neutral') {
    const eyes = expression === 'angry' ? `<path d="M35 42 L48 48 M65 42 L52 48" stroke="#333" stroke-width="3"/><circle cx="38" cy="48" r="3" fill="#222"/> <circle cx="62" cy="48" r="3" fill="#222"/>` : `<circle cx="35" cy="48" r="4" fill="#222"/><circle cx="65" cy="48" r="4" fill="#222"/>`;
    return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="${colorBody}"/>${eyes}</svg>`;
}
function svgToUrl(svg) { return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg); }
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0; return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16); }); }

/* --- 3. GLOBAL STATE & ASSETS --- */
let currentState = STATE.START;
let mapData = [];
const player = { x: 7, y: 7, direction: 'south', level: 1, xp: 0, nextLevelXp: 100, maxHp: 100, currentHp: 100, collection: [], activeHue: 0, speed: 0.075, sprintMultiplier: 1.6 };
const KEYS = { w: false, a: false, s: false, d: false, shift: false };
const CHEATS = { alwaysCatch: false, forceWin: false, forceLose: false, showCatchRate: false };
const MODES = { EASY: ['Rock', 'Paper', 'Scissors'], NORMAL: ['Rock', 'Paper', 'Scissors', 'Lizard', 'Spock'] };

let currentBattleMode = 'EASY';
let currentViewMode = 'IMMERSIVE';
let transitionStartTime = 0;
let userScale = 1.0;
let titleScreenSrc = "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/transition_screens/titles_creen01.png";
let gameOverScreenSrc = "https://raw.githubusercontent.com/SalamancaTech/LSFC-Game/main/assets/transition_screens/fail_state01.png";

const SPRITE_CACHE = {};
const HERO_IMG = new Image();
const ENEMY_IMG = new Image();
let usingCustomSprite = false;
let battleHeroSrc = null;

const CUSTOM_SLOTS = { A: { battle: null, overworld: null }, B: { battle: null, overworld: null }, C: { battle: null, overworld: null }, D: { battle: null, overworld: null }, E: { battle: null, overworld: null } };

const canvas = document.getElementById('gameCanvas'); 
const ctx = canvas.getContext('2d'); 
let time = 0;

/* --- 4. ENGINE HELPERS --- */
function getCachedImage(src) { if (!SPRITE_CACHE[src]) { const img = new Image(); img.src = src; SPRITE_CACHE[src] = img; } return SPRITE_CACHE[src]; }

function renderSpriteToDiv(divId, imgSrc, isSvgString = false, filter = '') {
    const el = document.getElementById(divId); if(!el) return;
    if (isSvgString) { el.innerHTML = imgSrc; } 
    else { el.innerHTML = `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:contain; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5)) ${filter};">`; }
}

function checkCollision(x, y) {
    if (x < 0 || x >= CONFIG.gridSize || y < 0 || y >= CONFIG.gridSize) return true;
    const tx = Math.floor(x + 0.5), ty = Math.floor(y + 0.5);
    return mapData[ty][tx] === 1 || mapData[ty][tx] === 2;
}

function updatePlayerMovement() {
    if (currentState !== STATE.OVERWORLD) return;
    let dx = 0, dy = 0;
    if (KEYS.w) dy -= 1; if (KEYS.s) dy += 1; if (KEYS.a) dx -= 1; if (KEYS.d) dx += 1;
    if (dx === 0 && dy === 0) return;
    if (dy < 0) player.direction = 'north'; else if (dy > 0) player.direction = 'south'; else if (dx < 0) player.direction = 'west'; else if (dx > 0) player.direction = 'east';
    const len = Math.sqrt(dx*dx + dy*dy); dx /= len; dy /= len;
    let s = player.speed; if (KEYS.shift) s *= player.sprintMultiplier;
    const nx = player.x + dx * s, ny = player.y + dy * s;
    if (!checkCollision(nx, player.y)) player.x = nx;
    if (!checkCollision(player.x, ny)) player.y = ny;
    if (Math.random() < 0.005) triggerEncounter();
}

/* --- 5. UI & MENU HANDLERS --- */
function toggleMainMenu() { const el = document.getElementById('main-menu'); el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; }
function closeAllMenus() { document.getElementById('main-menu').style.display = 'none'; document.getElementById('settings-menu').style.display = 'none'; document.getElementById('team-drawer').style.display = 'none'; }
function openSettings() { document.getElementById('main-menu').style.display = 'none'; document.getElementById('settings-menu').style.display = 'flex'; updateSettingsUI(); }
function closeSettings() { document.getElementById('settings-menu').style.display = 'none'; document.getElementById('main-menu').style.display = 'flex'; }

function updateHUD() {
    const container = document.getElementById('hud-slots'); if(!container) return;
    container.innerHTML = '';
    const activeMembers = player.collection.filter(c => c.active).slice(0, 5);
    if (activeMembers.length === 0) { const empty = document.createElement('div'); empty.className = 'oc-icon'; empty.style.borderStyle = 'dashed'; empty.style.opacity = '0.5'; container.appendChild(empty); }
    activeMembers.forEach(oc => {
        const icon = document.createElement('div'); icon.className = 'oc-icon';
        const species = SPECIES_DB.find(s => s.id === oc.speciesId);
        let src = species ? species.battle : ENEMY_IMG.src;
        icon.innerHTML = `<img src="${src}" style="filter:hue-rotate(${oc.hue}deg)">`;
        if (oc.isLead) icon.innerHTML += `<div class="lead-star">‚òÖ</div>`;
        container.appendChild(icon);
    });
}

function toggleTeamDrawer() {
    const drawer = document.getElementById('team-drawer');
    const isOpen = drawer.style.display === 'flex';
    drawer.style.display = isOpen ? 'none' : 'flex';
    if (!isOpen) renderTeamGrid();
}

function renderTeamGrid() {
    const grid = document.getElementById('team-grid'); grid.innerHTML = '';
    if (player.collection.length === 0) { grid.innerHTML = 'No OCs collected.'; return; }
    player.collection.forEach((oc, idx) => {
        const card = document.createElement('div');
        card.className = `team-member ${oc.active ? 'active' : ''} ${oc.isLead ? 'lead' : ''}`;
        const species = SPECIES_DB.find(s => s.id === oc.speciesId);
        let src = species ? species.battle : ENEMY_IMG.src;
        card.innerHTML = `<img src="${src}" style="filter:hue-rotate(${oc.hue}deg)"><div class="team-member-name">${oc.name}</div>`;
        card.onclick = () => { oc.active = !oc.active; renderTeamGrid(); updateHUD(); };
        grid.appendChild(card);
    });
}

function updateSettingsUI() {
    document.getElementById('style-toggle').innerText = "Mode: " + currentBattleMode;
    document.getElementById('view-toggle').innerText = "View: " + currentViewMode;
    document.getElementById('cheat-rate').innerText = "Show Convince %: " + (CHEATS.showCatchRate ? "ON" : "OFF");
}

function toggleBattleStyle() { currentBattleMode = currentBattleMode === 'EASY' ? 'NORMAL' : 'EASY'; localStorage.setItem('lfc_battle_mode', currentBattleMode); updateSettingsUI(); }
function toggleViewMode() { currentViewMode = currentViewMode === 'IMMERSIVE' ? 'HANDHELD' : 'IMMERSIVE'; document.getElementById('game-container').className = currentViewMode === 'HANDHELD' ? 'handheld-mode' : ''; resize(); updateSettingsUI(); }
function toggleCheat(c) { CHEATS[c] = !CHEATS[c]; updateSettingsUI(); }

/* --- 6. GAME ASSETS --- */
const AssetCache = { grass: null, water: null, tree: null };
function generateTextures() {
    const size = 128; const gCan = document.createElement('canvas'); gCan.width = size; gCan.height = size; const gCtx = gCan.getContext('2d');
    gCtx.fillStyle = '#2ecc71'; gCtx.fillRect(0,0,size,size); AssetCache.grass = gCan;
    const wCan = document.createElement('canvas'); wCan.width = size; wCan.height = size; const wCtx = wCan.getContext('2d');
    wCtx.fillStyle = '#3498db'; wCtx.fillRect(0,0,size,size); AssetCache.water = wCan;
    const tCan = document.createElement('canvas'); tCan.width = 200; tCan.height = 300; const tCtx = tCan.getContext('2d');
    tCtx.fillStyle = '#5d4037'; tCtx.fillRect(80, 200, 40, 100); tCtx.fillStyle = '#2e7d32'; tCtx.beginPath(); tCtx.arc(100, 100, 80, 0, Math.PI*2); tCtx.fill(); AssetCache.tree = tCan;
}

function generateMap() {
    mapData = [];
    for(let y=0; y<CONFIG.gridSize; y++) {
        let row = [];
        for(let x=0; x<CONFIG.gridSize; x++) {
            const r = Math.random();
            if (x===0||x===CONFIG.gridSize-1||y===0||y===CONFIG.gridSize-1) row.push(1);
            else if (r > 0.9) row.push(1); else if (r > 0.97) row.push(2); else row.push(0);
        }
        mapData.push(row);
    }
    mapData[7][7] = 0;
}

/* --- 7. BATTLE LOGIC --- */
const BattleFX = {
    async windUp(isPlayer) {
        const el = document.getElementById(isPlayer ? 'battle-hero' : 'battle-enemy');
        el.classList.add(isPlayer ? 'anim-windup-right' : 'anim-windup-left');
        await new Promise(r => setTimeout(r, 800));
        el.classList.remove(isPlayer ? 'anim-windup-right' : 'anim-windup-left');
    },
    async attack(move, isPlayer) {
        const el = document.getElementById(isPlayer ? 'battle-hero' : 'battle-enemy');
        el.classList.add(isPlayer ? 'anim-lunge-right' : 'anim-lunge-left');
        const target = document.getElementById(isPlayer ? 'battle-enemy' : 'battle-hero');
        await new Promise(r => setTimeout(r, 400));
        target.classList.add('anim-damage');
        await new Promise(r => setTimeout(r, 400));
        el.classList.remove(isPlayer ? 'anim-lunge-right' : 'anim-lunge-left');
        target.classList.remove('anim-damage');
    },
    async spinEnemyMove(targetMove) {
        const slot = document.getElementById('enemy-move-slot'); if(!slot) return;
        slot.style.opacity = '1'; slot.style.transform = 'scale(1)';
        const possibleMoves = MODES[currentBattleMode];
        let delay = 50; const startTime = Date.now(), duration = 2000; 
        const getIcon = (m) => MOVES_INFO[m] ? MOVES_INFO[m].icon : '?';
        await new Promise(resolve => {
            const cycle = () => {
                const move = possibleMoves[Math.floor(Math.random()*possibleMoves.length)];
                slot.innerText = getIcon(move); slot.style.color = MOVES_INFO[move]?.color || '#fff';
                const elapsed = Date.now() - startTime;
                if (elapsed < duration) { delay += (elapsed / duration) * 20; setTimeout(cycle, delay); } 
                else { slot.innerText = getIcon(targetMove); slot.style.transform = 'scale(1.3)'; setTimeout(() => { slot.style.transform = 'scale(1)'; resolve(); }, 200); }
            };
            cycle();
        });
        await new Promise(r => setTimeout(r, 500)); slot.style.opacity = '0';
    }
};

class Battle {
    constructor() {
        const wildIdx = Math.floor(Math.random()*SPECIES_DB.length);
        this.enemyData = { id: generateUUID(), name: SPECIES_DB[wildIdx].name, hue: Math.random()*360, maxHp: 100, currentHp: 100, speciesId: SPECIES_DB[wildIdx].id };
        const lead = player.collection.find(c => c.active && c.isLead);
        this.activeBattler = lead || player; this.isPlayerChar = !lead;
        this.enemyHp = 100; this.active = true;
    }
    async resolve(pMove) {
        if (!this.active) return; this.toggleControls(false);
        if (pMove === 'Convince') { await this.performCapture(); return; }
        const moves = MODES[currentBattleMode]; let eMove = moves[Math.floor(Math.random() * moves.length)];
        this.log(`You chose ${pMove}...`); await BattleFX.spinEnemyMove(eMove);
        if (pMove === eMove) { await Promise.all([BattleFX.windUp(true), BattleFX.windUp(false)]); this.log("Draw!"); }
        else if (MATCHUPS[pMove].beats.includes(eMove)) { await BattleFX.windUp(true); await BattleFX.attack(pMove, true); this.enemyHp -= 25; }
        else { await BattleFX.windUp(false); await BattleFX.attack(eMove, false); this.activeBattler.currentHp -= 15; }
        this.updateUI(); if (this.enemyHp <= 0) this.end(true); else if (this.activeBattler.currentHp <= 0) this.end(false); else this.toggleControls(true);
    }
    async performCapture() {
        this.log("Convincing..."); await new Promise(r => setTimeout(r, 1500));
        if (Math.random() < 0.5) { this.log("Success!"); player.collection.push(this.enemyData); this.end(true, true); }
        else { this.log("Failed!"); this.activeBattler.currentHp -= 10; this.updateUI(); this.toggleControls(true); }
    }
    updateVisuals() {
        document.getElementById('player-name').innerText = this.isPlayerChar ? "YOU" : this.activeBattler.name;
        let pSrc = (this.isPlayerChar && battleHeroSrc) ? battleHeroSrc : (this.isPlayerChar ? HERO_IMG.src : SPECIES_DB.find(s=>s.id===this.activeBattler.speciesId).battle);
        renderSpriteToDiv('hero-img-layer', pSrc, false, `hue-rotate(${this.isPlayerChar ? player.activeHue : this.activeBattler.hue}deg)`);
        let eSrc = SPECIES_DB.find(s=>s.id===this.enemyData.speciesId).battle;
        renderSpriteToDiv('enemy-img-layer', eSrc, false, `hue-rotate(${this.enemyData.hue}deg)`);
    }
    updateUI() {
        document.getElementById('player-hp-bar').style.width = (this.activeBattler.currentHp / (this.activeBattler.maxHp||100))*100 + '%';
        document.getElementById('enemy-hp-bar').style.width = this.enemyHp + '%';
        document.getElementById('player-hp-text').innerText = `${Math.max(0,this.activeBattler.currentHp)}/${this.activeBattler.maxHp}`;
        if(CHEATS.showCatchRate) {
            const catchBtn = document.querySelector('.btn-catch');
            if(catchBtn) catchBtn.innerText = `CONVINCE (${Math.floor(Math.min(1, (1-(this.enemyHp/100))*0.8)*100)}%)`;
        }
    }
    log(t) { document.getElementById('battle-log').innerText = t; }
    toggleControls(on) { document.querySelectorAll('.move-btn').forEach(b => b.disabled = !on); }
    end(win) { this.active = false; setTimeout(() => returnToOverworld(), 1000); }
}

/* --- 8. FLOW CONTROL --- */
function triggerEncounter() { currentState = STATE.TRANSITION; transitionStartTime = Date.now(); userScale = CONFIG.scale; }
function startBattle() { 
    currentState = STATE.BATTLE; 
    battleState = new Battle(); 
    const area = document.getElementById('battle-controls-area'); 
    area.innerHTML = '';
    MODES[currentBattleMode].forEach(m => {
        const btn = document.createElement('button'); btn.className = `move-btn btn-${m.toLowerCase()}`; btn.innerText = m;
        btn.onclick = () => battleState.resolve(m); area.appendChild(btn);
    });
    const catchBtn = document.createElement('button'); catchBtn.className = 'move-btn btn-catch'; catchBtn.innerText = "CONVINCE";
    catchBtn.onclick = () => battleState.resolve('Convince'); area.appendChild(catchBtn);
    const runBtn = document.createElement('button'); runBtn.className = 'move-btn btn-run'; runBtn.innerText = "RUN";
    runBtn.onclick = () => { currentState = STATE.OVERWORLD; document.getElementById('battle-ui').style.display = 'none'; }; area.appendChild(runBtn);
    document.getElementById('battle-ui').style.display = 'flex'; 
    battleState.updateVisuals(); 
    battleState.updateUI(); 
}
function returnToOverworld() { document.getElementById('result-screen').style.display = 'none'; document.getElementById('battle-ui').style.display = 'none'; currentState = STATE.OVERWORLD; document.getElementById('oc-hud').style.display = 'flex'; updateHUD(); }
function updateTransition() { const prog = Math.min((Date.now() - transitionStartTime)/1200, 1); if (prog >= 1) startBattle(); }

function selectStarter(id) {
    const s = SPECIES_DB.find(x => x.id === id); player.collection.push({ ...s, active: true, isLead: true, hue: 0, currentHp: 100, maxHp: 100, speciesId: s.id });
    HERO_IMG.src = s.overworld; startGame();
}
function startGame() { generateMap(); document.getElementById('start-screen').style.display='none'; currentState = STATE.OVERWORLD; document.getElementById('oc-hud').style.display='flex'; updateHUD(); resize(); loop(); }

function loop() {
    time += 0.05;
    if (currentState === STATE.OVERWORLD) { updatePlayerMovement(); drawWorld(); }
    else if (currentState === STATE.TRANSITION) { updateTransition(); drawWorld(true); }
    requestAnimationFrame(loop);
}

function drawWorld(shake = false) {
    ctx.fillStyle = CONFIG.colors.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const s = CONFIG.tileSize * CONFIG.scale, tw = s, th = s * 0.75;
    const ox = (canvas.width/2)-(player.x*tw)-(tw/2) + (shake?(Math.random()-0.5)*20:0);
    const oy = (canvas.height/2)-(player.y*th)-(th/2) + (shake?(Math.random()-0.5)*20:0);
    for (let y=0; y<CONFIG.gridSize; y++) {
        for (let x=0; x<CONFIG.gridSize; x++) {
            const sx = (x*tw)+ox, sy = (y*th)+oy;
            if (mapData[y][x] === 0) ctx.drawImage(AssetCache.grass, sx, sy, tw, th);
            else if (mapData[y][x] === 2) ctx.drawImage(AssetCache.water, sx, sy, tw, th);
            else { ctx.drawImage(AssetCache.grass, sx, sy, tw, th); ctx.drawImage(AssetCache.tree, sx-tw*0.25, sy-th*0.75, tw*1.5, th*2); }
        }
        if (Math.round(player.y) === y) drawPlayerSprite((player.x*tw)+ox, (player.y*th)+oy, tw, th);
    }
}
function drawPlayerSprite(x, y, tw, th) {
    const s = 60 * CONFIG.scale; ctx.filter = `hue-rotate(${player.activeHue}deg)`;
    const img = getCachedImage(HERO_IMG.src);
    if (img.complete) {
        const cw = img.naturalWidth / 2, ch = img.naturalHeight / 2;
        let sx=0, sy=0;
        switch(player.direction) { case 'north': sx=cw; break; case 'south': sy=ch; break; case 'east': sx=cw; sy=ch; break; }
        ctx.drawImage(img, sx, sy, cw, ch, x+tw/2-s/2, y+th/2-s, s, s);
    }
    ctx.filter = 'none';
}

function initStartScreen() {
    document.getElementById('start-screen').style.backgroundImage = `url(${titleScreenSrc})`;
    const grid = document.getElementById('starter-selection'); grid.innerHTML = '';
    SPECIES_DB.forEach(species => {
        const card = document.createElement('div'); card.className = 'selection-card';
        card.innerHTML = `<img src="${species.overworld}"><div class="selection-name">${species.name}</div>`;
        card.onclick = () => selectStarter(species.id); grid.appendChild(card);
    });
}

function resize() { canvas.width = document.getElementById('game-container').clientWidth; canvas.height = document.getElementById('game-container').clientHeight; }

/* --- 9. INITIALIZATION --- */
window.addEventListener('resize', resize);
window.addEventListener('keydown', e => { if(e.key.length===1) KEYS[e.key.toLowerCase()] = true; if(e.key==='Shift') KEYS.shift=true; });
window.addEventListener('keyup', e => { if(e.key.length===1) KEYS[e.key.toLowerCase()] = false; if(e.key==='Shift') KEYS.shift=false; });

generateTextures();
initStartScreen();
resize();
</script>
</body>
</html>
